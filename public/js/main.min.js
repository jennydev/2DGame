function start(){generateMap(),$("#new-game").on("click",function(){generateMap()}),$(".sound-icon").on("click",function(){$(this).toggleClass("disabled-sound"),soundOn=!soundOn})}function bindBlockClick(a){a.on("click",function(){var a=$(this),e=$(".active");if(e.removeClass("active"),a.addClass("active"),playSound(sounds.select),selectAllowed&&e.length>0){var t=parseInt(e.attr("row")),s=parseInt(e.attr("col")),n=parseInt(a.attr("row")),o=parseInt(a.attr("col"));if(Math.abs(t-n)<=1&&Math.abs(s-o)<=1){playSound(sounds.move),selectAllowed=!1;var m=mapData[t][s].gemType,i=mapData[n][o].gemType,l=mapData[t][s].image,r=mapData[n][o].image;mapData[t][s].image=r,mapData[n][o].image=l,mapData[t][s].gemType=i,mapData[n][o].gemType=m;var p=81*n,c=81*o;e.animate({left:c+"px",top:p+"px"},300);var d=81*t,g=81*s;a.attr({col:s,row:t}),e.attr({col:o,row:n}),a.find(".helper-info").html(t+":"+s),e.find(".helper-info").html(n+":"+o),a.removeClass("active"),a.animate({left:g+"px",top:d+"px"},300,function(){checkGems(mapData),gemsMatch.length>0?destroyGems(gemsMatch):(playSound(sounds.disabledmove),a.animate({left:c+"px",top:p+"px"},300,function(){selectAllowed=!0}),e.animate({left:g+"px",top:d+"px"},300,function(){}),a.attr({col:o,row:n}),e.attr({col:s,row:t}),mapData[n][o].image=r,mapData[t][s].image=l,mapData[n][o].gemType=i,mapData[t][s].gemType=m)})}}})}function generateMap(){playSound(sounds.start),addImageAnimation("start"),stats={score:0,smashing:0,splendid:0,indubitably:0,marvelous:0,unbelievable:0,beer1:0,beer2:0},first=!0,updateScore(),mapData=[];for(var a=0;rows>a;a++){var e=[];mapData.push(e);var t=!0;a%2&&(t=!1);for(var s=0;rows>s;s++){if(t){var n=0;s%2&&(n=1)}else{var n=1;s%2&&(n=0)}var o=getRandomizer(1,7);o=getRandomGem(a,s,o,!0);var m={image:"assets/img/gem_"+o+".png",block:n,gemType:o,row:a,col:s};e.push(m)}}renderGems(mapData)}function checkGems(a){gemsMatch=[];for(var e=0;e<a.length;e++)for(var t=0;t<a[e].length;t++)getRandomGem(e,t,a[e][t].gemType,!1);gemsMatch=_.uniq(gemsMatch);var s=_.where(gemsMatch,{gemType:5}).length,n=_.where(gemsMatch,{gemType:6}).length;stats.beer1+=s,stats.beer2+=n,gemsMatch.length>0&&playSound(sounds.destroy),4==gemsMatch.length&&(playSound(sounds.splendid),addImageAnimation("splendid"),stats.splendid++),gemsMatch.length<5||(addImageAnimation("indubitably"),playSound(sounds.indubitably),stats.indubitably++),updateScore()}function moveGemsDown(a){for(var e=0;rows>e;e++){var t=_.where(a,{col:e});t.length>0;for(var s=mapData.length-1;s>=0;s--)_.each(t,function(a){var n=mapData[s][e];if(n.row<a.row){var o=_.filter(t,function(a){return a.row>n.row}),m=n.row+o.length,i=81*m,l=$("#gem-container").find(".block[row='"+n.row+"'][col='"+n.col+"']"),r=mapData[m][n.col];r.gemType=n.gemType,r.image="assets/img/gem_"+n.gemType+".png",l.attr("row",m),l.find(".helper-info").html(m+":"+e),l.animate({top:i+"px"},500,function(){})}});_.each(t,function(a,s){var n=getRandomizer(1,7),o=t.length-s-1,m=$('<div class="block white-block text-center" row="'+o+'" col="'+e+'"><span class="helper"><span class="helper-info">'+o+":"+e+"</span> </span></div>"),i=$('<img class="gem-img"/>');i.attr("src","assets/img/gem_"+n+".png"),m.find(".helper").append(i),m.css({top:81*(-1-s),left:81*e}),$("#gem-container").append(m),mapData[o][e].gemType=n,mapData[o][e].image="assets/img/gem_"+mapData[o][e].gemType+".png",m.animate({top:81*(t.length-1-s)+"px"},500,function(){bindBlockClick(m)})})}}function renderGems(a){$("#gem-container").empty();for(var e=0;e<a.length;e++)for(var t=0;t<a[e].length;t++){var s;s=$(1==a[e][t].block?'<div class="block white-block text-center" row="'+e+'" col="'+t+'"><span class="helper"><span class="helper-info">'+e+":"+t+"</span> </span></div>":'<div class="block white-block text-center" row="'+e+'" col="'+t+'"><span class="helper"><span class="helper-info">'+e+":"+t+"</span></span></div>");var n=$('<img class="gem-img"/>');n.attr("src",a[e][t].image),s.find(".helper").append(n),s.css({top:81*e,left:81*t}),$("#gem-container").append(s)}$(".block").each(function(){bindBlockClick($(this))})}function getRandomizer(a,e){return Math.floor(Math.random()*(1+e-a))+a}function getRandomGem(a,e,t,s){var n=!1;return mapData[a]&&mapData[a][e-1]&&mapData[a][e-2]&&t==mapData[a][e-1].gemType&&t==mapData[a][e-2].gemType&&(n=!0,s||(gemsMatch.push(mapData[a][e-2]),gemsMatch.push(mapData[a][e-1]),gemsMatch.push(mapData[a][e]))),mapData[a]&&mapData[a-1]&&mapData[a-2]&&t==mapData[a-1][e].gemType&&t==mapData[a-2][e].gemType&&(n=!0,s||(gemsMatch.push(mapData[a-2][e]),gemsMatch.push(mapData[a-1][e]),gemsMatch.push(mapData[a][e]))),n&&s&&(t=t>4?8-t:7-t),t}function destroyGems(a){selectAllowed=!1;for(var e=0;e<a.length;e++){var t=$("<div/>",{"class":"destroy-gems"}),s=$("#gem-container").find(".block[row='"+a[e].row+"'][col='"+a[e].col+"']");s.find("img").hide(),s.append(t),playAnimation(t)}setTimeout(function(){moveGemsDown(gemsMatch),setTimeout(function(){checkGems(mapData),gemsMatch.length>0?(combo++,destroyGems(gemsMatch)):(1==combo&&(playSound(sounds.smashing),addImageAnimation("smashing"),stats.smashing++,stats.score+=100),2==combo&&(addImageAnimation("marvelous"),playSound(sounds.marvelous),stats.marvelous++,stats.score+=200),3>combo||(addImageAnimation("unbelievable"),playSound(sounds.unbelievable),stats.unbelievable++,stats.score+=400),updateScore(),combo=0,selectAllowed=!0)},500)},500)}function playAnimation(a){a.animateSprite({fps:25,loop:!1,autoplay:!1,animations:{start:[0,1,2,3,4,5,6]},complete:function(){a.closest(".block").remove()}}),a.animateSprite("play","start")}function updateScore(){3==gemsMatch.length&&(stats.score+=30),4==gemsMatch.length&&(stats.score+=60),gemsMatch.length>4&&(stats.score+=60+10*gemsMatch.length);for(var a in stats)if(stats.hasOwnProperty(a)){var e=stats[a];$("."+a).html(e)}}function playSound(a){if(soundOn){var a=new Audio(a);a.play()}}function addImageAnimation(a,e){$(".inner-container").find("img").hide(),void 0==e&&(e=1200);var t=$(".inner-container").find("."+a);t.show(),t.addClass("shake"),setTimeout(function(){t.removeClass("shake"),t.fadeOut("fast")},e)}var rows=8,mapData=[],gemsMatch=[],selectAllowed=!0,first=!0,soundOn=!0,stats={score:0,smashing:0,splendid:0,indubitably:0,marvelous:0,unbelievable:0,beer1:0,beer2:0},combo=0,sounds={start:"assets/sounds/start.mp3",smashing:"assets/sounds/smashing.mp3",splendid:"assets/sounds/splendid.mp3",marvelous:"assets/sounds/marvelous.mp3",unbelievable:"assets/sounds/unbelievable.mp3",select:"assets/sounds/select.mp3",move:"assets/sounds/move.mp3",disabledmove:"assets/sounds/disabledmove.mp3",first:"assets/sounds/first_of_many.mp3",indubitably:"assets/sounds/indubitably.mp3",destroy:"assets/sounds/destroy.mp3"};